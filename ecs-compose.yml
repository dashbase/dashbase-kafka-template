version: '2'

services:
  table:
    image: 977933106931.dkr.ecr.us-west-1.amazonaws.com/dashbase/table
    cpu_shares: 2048
    mem_limit: 4g
    volumes:
      - /home/ec2-user/logs:/app/kafka-configurations/dashbase-tables/kafka/logs:rw
      - /home/ec2-user/logs:/root/.dashbase/logs:rw
      - /home/ec2-user/index:/data/index:rw
    env_file:
      - saas_kafka_config.env
    environment:
      - ZOOKEEPER_URL=13.56.187.40:2181
      - MONITOR_URL=localhost:9888
      - LOG=/root/.dashbase/logs/debug.log
      - COMMAND=sleep 10s && dashbase-cli template download ecs-configurations --path /app/ && dashbase-cli --no-verify --distribution release service start table -p 7889 -ap 7989 -r 0 -c /app/ecs-configurations/dashbase-tables/filebeat/conf/config.yml saas-table-0
  api:
    image: 977933106931.dkr.ecr.us-west-1.amazonaws.com/dashbase/api
    cpu_shares: 512
    mem_limit: 1g
    ports:
      - "9876:9876"
      - "9976:9976"
    volumes:
      - /home/ec2-user/logs:/app/kafka-configurations/dashbase-api/logs:rw
      - /home/ec2-user/logs:/root/.dashbase/logs:rw
    links:
      - table
    environment:
      - ZOOKEEPER_URL=13.56.187.40:2181
      - MONITOR_URL=localhost:9888
      - LOG=/root/.dashbase/logs/debug.log
      - COMMAND=sleep 10s && dashbase-cli template download ecs-configurations --path /app/ && dashbase-cli --no-verify --distribution release service start api -p 9876 -ap 9976 -c /app/ecs-configurations/dashbase-api/conf/config.yml saas-api
  web:
    image: 977933106931.dkr.ecr.us-west-1.amazonaws.com/dashbase/web
    cpu_shares: 512
    mem_limit: 1g
    ports:
      - "8080:8080"
      - "8180:8180"
    volumes:
      - /home/ec2-user/logs:/root/.dashbase/logs:rw
    links:
      - api
    environment:
      - API_PORT=9876
      - API_HOST=api
      - LOG=/root/.dashbase/logs/debug.log
      - COMMAND=sleep 15s && dashbase-cli template download ecs-configurations --path /app/ && dashbase-cli --no-verify --distribution release service start web -p 8080 -ap 8180 -c /app/ecs-configurations/dashbase-web/conf/config.yml saas-web

  raven:
    image: 977933106931.dkr.ecr.us-west-1.amazonaws.com/dashbase/three-eyed-raven
    cpu_shares: 1024
    mem_limit: 1g
    ports:
      - "12445:12445"
      - "12545:12545"
    volumes:
      - /home/ec2-user/logs/:/root/.dashbase/logs/:rw
    env_file:
      - saas_kafka_config.env
    environment:
      - PORT=12445
      - ADMINPORT=12545
    command: java -cp data-pipeline-1.0.0-SNAPSHOT.jar io.dashbase.ter.WargKafkaStreamsApplication server conf/saas-kafka-config.yml
